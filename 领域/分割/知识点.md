## 分割相关知识

### 损失
- **Dice**  
  - dice是医学图像中的常见指标。它本质上是两个样本的重叠的度量。 此度量值范围是0到1**，其中Dice系数为1**表示完美且完整的重叠。直观上理解，如下图：    
   		 ![](https://github.com/sfxz035/DL-Learning/raw/master/picture/20180607161135809.png)  
   		 计算公式为：  
   		 
	![enter image description here](https://github.com/sfxz035/DL-Learning/raw/master/picture/1556345040%281%29.jpg)   
	where |A∩B| 代表集合A和B的共同元素，并且| A | 表示集合A中的元素的数量（| B | 表示集合B中的元素的数量）。  
    - 对于在预测分割掩模上评估Dice系数的情况，|A∩B|的近似可以通过将预测和目标掩膜**按元素**（即对应点）相乘，然后对得到的矩阵进行求和得到。  
    因为目标掩模是二进制的，所以我们有效地将预测中没有在目标掩模中“激活”的任何像素清零。 对于剩余的像素，我们基本上采取惩罚低置信度的预测的策略; 该分子中的这个表达式的较高值会导致更好的Dice系数。
     - 为了量化| A | 和| B |，一些研究人员使用简单的求和，而其他研究人员则倾向于使用平方和。
  - **定义为损失**  
     以上计算都是衡量分割效果的指标，最佳效果时为1。想用该指标作为最小化损失时，可以制定为1-Dice。
     该损失只适用于0，1二值化的分割结果。（多类别的需要多通道分别计算再求均值）。
  - **tensorflow代码**  
      1. tensorlayer中  
         `def dice_coe()`       
      3. tensorflow
     ```
      def dice_coef_theoretical(y_pred, y_true):
	      """Define the dice coefficient
	        Args:
	        y_pred: Prediction
	        y_true: Ground truth Label
	        Returns:
	        Dice coefficient
	        """
	      y_true_f = tf.cast(tf.reshape(y_true, [-1]), tf.float32)
	      y_pred_f = tf.nn.sigmoid(y_pred)
	      y_pred_f = tf.cast(tf.greater(y_pred_f, 0.5), tf.float32)
	      y_pred_f = tf.cast(tf.reshape(y_pred_f, [-1]), tf.float32)
	      intersection = tf.reduce_sum(y_true_f * y_pred_f)
	      union = tf.reduce_sum(y_true_f) + tf.reduce_sum(y_pred_f)
	      dice = (2. * intersection) / (union + 0.00001)
	      if (tf.reduce_sum(y_pred) == 0) and (tf.reduce_sum(y_true) == 0):
		      dice = 1
      ```
      参考：[https://zhuanlan.zhihu.com/p/37269080]  
  - **dice loss 适用情况**   
    dice loss提出与V-net，一部分原因使分割区域仅占扫描区域的一小部分，为了增加前景区域的权重使用了dice loss。   
    - 缺点  
      有时使用dice loss会使训练曲线有时不可信，而且dice loss好的模型并不一定在其他的评价标准上效果更好，例如mean surface distance 或者是Hausdorff surface distance。
不可信的原因是梯度，对于softmax或者是log loss其梯度简化而言为p−t p-tp−t，t tt为目标值，p pp为预测值。而dice loss为2t2(p+t)2 \frac{2t^2}{(p+t)^2} 
(p+t)22t 2，如果p pp，t tt过小则会导致梯度变化剧烈，导致训练困难。

- loss相关文章  
  1. sigmoid+dice loss ： [1]V-Net: Fully Convolutional Neural Networks for Volumetric Medical Image Segmentation, International Conference on 3D Vision, 2016。
  2. lovasz loss ： The Lovász-Softmax loss: A tractable surrogate for the optimization of the intersection-over-union measure in neural networks
<!--stackedit_data:
eyJoaXN0b3J5IjpbMjYwNTg0NzYxLDE4NzU4NzE0MDUsLTE5Nj
Q4NTUxMjAsLTExNTgyODY1MCw3MjMxNTAzMjUsLTE2NDQ3MjQ0
NDYsLTk0NjA4NDY2MiwxNDU0OTAzMDAsMzcxNTQwMjcxXX0=
-->